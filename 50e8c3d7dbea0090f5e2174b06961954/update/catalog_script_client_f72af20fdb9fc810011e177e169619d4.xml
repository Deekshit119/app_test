<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="catalog_script_client">
    <catalog_script_client action="INSERT_OR_UPDATE">
        <active>true</active>
        <applies_catalog>true</applies_catalog>
        <applies_extended>false</applies_extended>
        <applies_req_item>false</applies_req_item>
        <applies_sc_task>false</applies_sc_task>
        <applies_target_record>true</applies_target_record>
        <applies_to>item</applies_to>
        <cat_item display_value="Demande de remboursement">ff844a95db3ec090011e177e16961952</cat_item>
        <cat_variable/>
        <condition/>
        <description/>
        <field/>
        <global>true</global>
        <isolate_script>true</isolate_script>
        <messages/>
        <name>HVS FormValidation</name>
        <order>10</order>
        <script><![CDATA[function onSubmit() {
	//Type appropriate comment here, and begin script below
	g_form.hideFieldMsg('end_date');
	var bOK = g_form.getValue("formok");
	if (bOK == 'date_invalid') {
		 	getMessage('x_hdvi2_expense.endDate.not.valid', function(msg) {
		 		g_form.showFieldMsg('end_date',msg,'error');
		 	});
		g_form.setValue("formok",'true');
		return false;
	}

	// Code Loga avec pièce jointe
	// 807 Frais hébergement
	// 806 Frais transport publics-parking
	if(g_form.getValue("sr_loga_code") == '807' || g_form.getValue("sr_loga_code") == '806') { // Sys_id Rubrique : Frais de repas hors canton
		if(this.document.getElementsByClassName('get-attachment').length == 0) {
			getMessage('expense.modal.warning', function(modalTitle) {
			
				getMessage('expense.rubric.message.attachment', function(msg) {
					if (typeof spModal != 'undefined') {
						spModal.open({
							title: modalTitle,
							message: msg,
							buttons: [
							{label:'OK', primary: true}
								],
								backdrop: 'static'
							}).then(function(){
								return false;
							});
						}
					});
			});
			return false;
		}
	}
			
	
	if (g_form.getValue("formok")=='trueSubmit') { //getClientData implemented below
			return true;
	}	

	var sdateFormat = ''+g_form.getValue("sr_date_expense");
	var sdateExp = sdateFormat.substr(6, 4)+'-'+sdateFormat.substr(3, 2)+'-'+sdateFormat.substr(0, 2);

	if(g_form.getValue("sr_requested_amount")!='' && g_form.getValue("sr_requested_amount")!='0') {
	var grDupAmount= new GlideRecord('x_hdvi2_expense_line');
		grDupAmount.addQuery('active',true);
		grDupAmount.addQuery('rubric',g_form.getValue("sr_rubrique_loga"));
		grDupAmount.addQuery('date_expense',sdateExp);
		grDupAmount.addQuery('requested_amount',parseFloat(g_form.getValue("sr_requested_amount")));
		grDupAmount.query(CheckDuplicate);
	}
	if(g_form.getValue("sr_requested_value")!='' && g_form.getValue("sr_requested_value")!='0') {
		var grDupValue= new GlideRecord('x_hdvi2_expense_line');
		grDupValue.addQuery('active',true);
		grDupValue.addQuery('rubric',g_form.getValue("sr_rubrique_loga"));
		grDupValue.addQuery('date_expense',sdateExp);
		grDupValue.addQuery('requested_value',parseFloat(g_form.getValue("sr_requested_value")));
		grDupValue.query(CheckDuplicate);
	}

	return false;
		
	function CheckDuplicate(grDup) {

		//Perform validation
		if(grDup.next()) {
			//If the user is valid, set client data user_validated to true
			g_form.setValue("sr_doublon",'Yes');
			getMessage('expense.modal.warning', function(modalTitle) {
		
				getMessage('expense.duplicates.records', function(msg) {
					if (typeof spModal != 'undefined') {
						spModal.open({
							title: modalTitle, //'Avertissement',
							message: msg ,
							backdrop: 'static'
						}).then(function(){
							g_form.setValue("formok",'trueSubmit');
							//then re-submit
							g_form.submit();
						}, function(){
							g_form.setValue("formok",'falseSubmit');
							//set the client data user_validated element to false
						});
					}
				});
			});
		}
		else {
			g_form.setValue("sr_doublon",'No');
			g_form.setValue("formok",'trueSubmit');
            g_form.submit();
		}


	}
}

/*
var ga = new GlideAjax('HVSExpenseUtils');
ga.addParam('sysparm_name', 'checkDuplicate');
ga.addParam('paramRubric',g_form.getValue("sr_rubrique_loga"));
ga.addParam('paramDate',g_form.getValue("sr_date_expense"));
ga.addParam('paramAmount',g_form.getValue("sr_requested_amount"));
ga.addParam('paramValue',g_form.getValue("sr_requested_value"));
ga.getXML(function (response) {
	var answer = response.responseXML.documentElement.getAttribute("answer");
	if(answer) {
		g_form.setValue("sr_doublon",'Yes');
	}
	else g_form.setValue("sr_doublon",'No');
});

if(g_form.getValue("sr_doublon")=='Yes') {
	getMessage('expense.duplicates.records', function(msg) {
		if (typeof spModal != 'undefined') {
			spModal.open({
				title: 'Avertissement',
				message: msg ,
				backdrop: 'static'
			}).then(function(){
				
				g_form.setValue("formok",'true');
				return true;
			}, function(){
				g_form.setValue("formok",'false');
				return false;
			});
		}
	});
}
*/							]]></script>
        <sys_class_name>catalog_script_client</sys_class_name>
        <sys_created_by>h40009222</sys_created_by>
        <sys_created_on>2020-03-06 21:37:45</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>f72af20fdb9fc810011e177e169619d4</sys_id>
        <sys_mod_count>122</sys_mod_count>
        <sys_name>HVS FormValidation</sys_name>
        <sys_overrides display_value="">global</sys_overrides>
        <sys_package display_value="Expense Management" source="x_hdvi2_expense">50e8c3d7dbea0090f5e2174b06961954</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Expense Management">50e8c3d7dbea0090f5e2174b06961954</sys_scope>
        <sys_update_name>catalog_script_client_f72af20fdb9fc810011e177e169619d4</sys_update_name>
        <sys_updated_by>h40009222</sys_updated_by>
        <sys_updated_on>2020-03-09 10:43:17</sys_updated_on>
        <table/>
        <type>onSubmit</type>
        <ui_type>10</ui_type>
        <variable_set/>
        <view/>
    </catalog_script_client>
</record_update>
