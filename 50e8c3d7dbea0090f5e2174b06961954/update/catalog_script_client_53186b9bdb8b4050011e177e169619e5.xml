<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="catalog_script_client">
    <catalog_script_client action="INSERT_OR_UPDATE">
        <active>true</active>
        <applies_catalog>true</applies_catalog>
        <applies_extended>false</applies_extended>
        <applies_req_item>true</applies_req_item>
        <applies_sc_task>true</applies_sc_task>
        <applies_target_record>true</applies_target_record>
        <applies_to>set</applies_to>
        <cat_item/>
        <cat_variable>IO:ba8daf25db324490011e177e16961937</cat_variable>
        <condition/>
        <description/>
        <field/>
        <global>true</global>
        <isolate_script>true</isolate_script>
        <messages/>
        <name>HVS Rubric Controls</name>
        <order/>
        <script><![CDATA[function onChange(control, oldValue, newValue, isLoading) {
	g_form.hideFieldMsg("sr_rubrique_loga");
	if (isLoading || newValue == '') {
		return;
	}

	g_form.setValue('sr_requested_amount','');
	g_form.setValue('sr_requested_value','');
	g_form.setValue('sr_exchange_rate','');
	g_form.setValue('sr_location_to','');
	g_form.setValue('sr_location','');
	g_form.setValue('sr_location_other','');
	g_form.setValue('sr_location_other','');
	g_form.setValue('sr_comments','');
	g_form.setValue('short_description','');
	g_form.setValue('sr_new_location_from_reason','');
	g_form.setReadOnly('sr_comments',false);
	g_form.setReadOnly('short_description',false);
	g_form.setValue('sr_currency','CHF');
	
	var ga2 = new GlideAjax('HVSExpenseUtils');
	ga2.addParam('sysparm_name', 'getLogaData');
	ga2.addParam('LogaRubricId', newValue);
	ga2.getXML(parseLogaData);	

	if(g_form.getValue("sr_rubrique_loga") == 'f7c37b13dbee0090f5e2174b0696194a') { // Rubrique Loga : Sélection Internet
		var ga = new GlideAjax('HVSExpenseUtils');
		ga.addParam('sysparm_name', 'isITWorker');
		ga.addParam('user_sys_id',g_user.userID);
		ga.getXML(parseUsersData);	
	}
	
	var attachmentButton = this.document.getElementsByTagName('sp-attachment-button');
	var sCurrentRubric = g_form.getValue("sr_rubrique_loga");
	var sListeRubricKM = 'e8e4b084db44149009b962a916961906,9805f444db44149009b962a916961908,edc49704dbd3c050f5e2174b06961901,fbc37b13dbee0090f5e2174b06961948';
	if(sListeRubricKM.indexOf(sCurrentRubric) >=0) {
		attachmentButton[0].parentNode.style.display = "none";
	}
	else {
		if(attachmentButton[0].parentNode.style.display == "none") attachmentButton[0].parentNode.style.display = "flex"; 
	}
}

function parseUsersData(response) {
	var answer = response.responseXML.documentElement.getAttribute("answer");

	try {
		if(answer && answer != '40f45da64fa426009539bc511310c784') { // Dépt. :  Service Informatiaue HVS
			getMessage('expense.modal.warning', function(modalTitle) {
				getMessage('expense.rubric.allowed.itonly', function(msg) {
					if (typeof spModal != 'undefined') {
						spModal.open({
							title: modalTitle,
							message:  g_form.getLabelOf("sr_rubrique_loga") + " : " + msg  + '\n\n' + g_form.getDisplayValue('sr_rubrique_loga')+' !!',
							buttons: [
								{label:'OK', primary: true}
							],
						backdrop: 'static'
						}).then(function(){
							g_form.setValue('sr_rubrique_loga','');
							return;
						});
					}			
				});			
			});
		}
	}
	catch(err){
		jslog(err.message);
	}
}

function parseLogaData(response) {
	var answer = response.responseXML.documentElement.getAttribute("answer");
	var sCode='';

	answer = JSON.parse(answer);
	try {
		if(answer) {
			sCode = ''||answer.code_loga;
			g_form.setValue('sr_loga_code',sCode);
			
			// Code Loga avec pièce jointe 
			// 807 Frais hébergement
			// 806 Frais transport publics-parking
			// D01 Divers
			if(sCode == '807' || sCode == '806' || sCode == 'D01') {
				getMessage('expense.rubric.message.attachment', function(msg) {
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
					});
				}
			// Afficher Infos additionnelles
			if(sCode == 'D01') {
				getMessage('expense.info.frais.divers', function(msg) {
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
					});
				}
			if(sCode == '807') {
				getMessage('expense.info.frais.hebergement', function(msg) {
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
					});
				}
			if(sCode == '806' && g_form.getValue("sr_rubrique_loga") == "73c37b13dbee0090f5e2174b0696194a") {
				getMessage('expense.info.frais.trains', function(msg) { 
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
					});
				}
			if(sCode == '800' && g_form.getValue("sr_rubrique_loga") != "3eae6cd5db831c50011e177e16961978") {
				var dDate = g_form.getValue("sr_date_expense");

				var ga3 = new GlideAjax('HVSExpenseDateUtils');
				ga3.addParam('sysparm_name', 'ValidateDates');
				ga3.addParam('sysparm_start', dDate);
				ga3.addParam('sysparm_end', '01.08.2020');
				ga3.getXML(CheckExpenseDates);
			}
		}

		// Code Loga montant maximum 
		// 855 Connexion internet
		// 800 PEtit-déjeuner
		if(sCode == '855' || (sCode == '800' && g_form.getValue("sr_rubrique_loga") == "3eae6cd5db831c50011e177e16961978")) {
			if(answer.max_amount!=0) g_form.setValue('sr_requested_amount',''||answer.max_amount);
		}
	}
	catch(err){
		jslog(err.message);
	}
}

function CheckExpenseDates(response) {
    var answer = response.responseXML.documentElement.getAttribute("answer");
	var oldDate = g_form.getValue("sr_date_expense");

    try {
        if (answer == 'false') {
			if(g_form.getValue("sr_rubrique_loga") == 'fbc37b13dbee0090f5e2174b06961949') {
				// Repas dans le Canton
				getMessage('expense.info.frais.repas.dans.canton.new', function(msg) {
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
				});
			}
			else if(g_form.getValue("sr_rubrique_loga") == 'bfc37b13dbee0090f5e2174b06961949') {
				// Repas hors Canton
				getMessage('expense.info.frais.repas.hors.canton.new', function(msg) {
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
				});
			}
		}
		else {
			if(g_form.getValue("sr_rubrique_loga") == 'fbc37b13dbee0090f5e2174b06961949') {
				// Repas dans le Canton
				getMessage('expense.info.frais.repas.dans.canton', function(msg) {
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
				});
			}
			else if(g_form.getValue("sr_rubrique_loga") == 'bfc37b13dbee0090f5e2174b06961949') {
				// Repas hors Canton
				getMessage('expense.info.frais.repas.hors.canton', function(msg) {
					g_form.showFieldMsg("sr_rubrique_loga",msg,"info");
				});
			}
		}
	}
	catch (err) {
        jslog('A JavaScript runtime error occurred: ' + err.message * '[Client Script HVS Rubric Controls - Form Demande de Remboursement]');
    }
}]]></script>
        <sys_class_name>catalog_script_client</sys_class_name>
        <sys_created_by>h40009222</sys_created_by>
        <sys_created_on>2020-02-24 09:21:12</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>53186b9bdb8b4050011e177e169619e5</sys_id>
        <sys_mod_count>140</sys_mod_count>
        <sys_name>HVS Rubric Controls</sys_name>
        <sys_overrides display_value="">global</sys_overrides>
        <sys_package display_value="HVS Expense Management" source="x_hdvi2_expense">50e8c3d7dbea0090f5e2174b06961954</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="HVS Expense Management">50e8c3d7dbea0090f5e2174b06961954</sys_scope>
        <sys_update_name>catalog_script_client_53186b9bdb8b4050011e177e169619e5</sys_update_name>
        <sys_updated_by>h40009222</sys_updated_by>
        <sys_updated_on>2021-01-08 15:30:13</sys_updated_on>
        <table/>
        <type>onChange</type>
        <ui_type>10</ui_type>
        <variable_set display_value="Lignes de dépenses SR">a048ae60db4b0410f5e2174b069619dc</variable_set>
        <view/>
    </catalog_script_client>
</record_update>
