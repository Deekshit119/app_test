<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function(spModal, $scope, $rootScope, $timeout,$window,  $location, spUtil, spAriaFocusManager) {
	var c = this;	
////////////////////////////////////////////////////

	
  var url = window.location.href;
	url = url.toString();
  $scope.setDisplayAppTeam='=1';
	c.data.setDisplayAppTeam='=1';
  c.data.reqExpSheetId='';
	c.data.action='';
  $scope.reqExpSheetId='';
	$scope.action='';
	c.data.comment='undefined';
	$scope.comment='undefined';

	if(!c.data.isApprover) {
		spModal.open({
			title: '${expense.modal.warning}',
			message: "${You are not authorized to view this page}",
			buttons: [
				{label:'OK', primary: true}
			],
			backdrop: 'static'
		}).then(function() {
			var hosturl = 'https://' + $window.location.host;
			$window.location.href = hosturl + "/exphvs"; 
			});
	}
				
	c.onWidgetOnly = function (explineid){
		var widgetExpenseOptionsOnly = {};
		widgetExpenseOptionsOnly.sys_id = explineid;
		widgetExpenseOptionsOnly.read_only = 'true';
	 
		spModal.open({
			//value: 'true,'+explineid,
			title: '${expense.edit.title_box}',
			widget: '9fb6b106db5f8850f5e2174b069619ae',
			buttons: [],
			backdrop: 'static',
			widgetInput: widgetExpenseOptionsOnly
		}).then(function () {
			  $scope.keywords='';
			  c.data.keywords='';
		});
	};
	
	c.SetApprovalExpense = function(reqid,action) {
			if(action=='reject') {
				spModal.open({
				title: '${Reject Request}',
				message: '${approvals.comments.userinfo}',
				input: true,
				backdrop: 'static',
				value: c.comment
				}).then(function(comment) {
						if(comment) {
							$scope.comment=comment;
							c.data.comment=comment;
							$scope.setDisplayAppTeam='=1';
							$scope.reqExpSheetId=reqid;
							c.data.setDisplayAppTeam='=1';
							c.data.reqExpSheetId=reqid;
							c.data.action=action;
							$rootScope.$broadcast('execRefresh', 'rejected');
							c.server.update();
						}
				});
			}
			else if(action=='approve') {
							$scope.comment='undefined';
							c.data.comment='undefined';
							$scope.setDisplayAppTeam='=1';
							$scope.reqExpSheetId=reqid;
							c.data.setDisplayAppTeam='=1';
							c.data.reqExpSheetId=reqid;
							c.data.action=action;
							$scope.action=action;
							$rootScope.$broadcast('execRefresh', 'approved');
							c.server.update();
			}
		};
	
		$rootScope.$on('execSubmitted', function(event,data) {
			c.server.update();
  });


}]]></client_script>
        <controller_as>c</controller_as>
        <css>.widget-data-table .clearfix{ 
	display: none; 
} 

.container {
  width: 1597px;
  padding-left: 0px;
  padding-right: 15px;
}

.pointer {
    cursor: pointer;
}

.v5001b062d7101200b0b044580e6103eb .sp-list-cell {
    white-space: pre-wrap;
}

.user-profile-tabs { 
  height: 60px; 
   
  .widget-header { 
    padding-bottom: 10px; 
    font-weight: normal; 
    color : $brand-primary;
  } 
 
  .no-padding { 
    padding-left : 0px; 
    text-align: center; 
    cursor: pointer; 
 
  } 
 
  .tab-row { 
    margin-top: 15px; 
  } 
} 
 
.widget-tabs { 
  border-bottom: 1px solid $csm-border-color;
  margin-bottom: 15px; 
} 
.widget-tabs { 
  border-bottom: 1px solid $csm-border-color;
} 

.tr-top {
  border-top: 1px solid #ddd;
}

.th-exp-title {
    color: $brand-primary; //#b92d33;
    display: inline-block;
}

.td_img {
		width: 30px;
  	height: 30px;
  	display: inline-block;
}

.td_img_refresh {
		width: 25px;
  	height: 25px;
  	font-weight: bold;
  	display: inline-block;
}

.thead {
    border-bottom: 1px solid #ddd;
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
    border-top: 1px solid #ddd;
}

h4 { 
  padding-left: 0px; 
  margin-bottom: 0px; 
} 
 
h4.selected-tab { 
  /*border-bottom: 2px solid #278EFC; */
  border-bottom: 2px solid $brand-primary; 
  color: $link-color;
} 

 
.profile-tabs { 
  clear: both; 
  padding-bottom: 15px; 
} 

.td-alignmiddle {
	vertical-align:middle;
}
  
.panel-heading{
 background-color : $brand-primary; 
}

.panel{
 margin-bottom : 0px; 
}

span.panel-title{
 color: $panel-default-heading-bg;
 /*vertical-align: sub;
  vertical-align: -webkit-baseline-middle;*/
}

.panel-heading &gt; .dropdown .dropdown-toggle {
   color: $panel-primary-text;
   /*padding-bottom: 0px;
   vertical-align: bottom;*/
}

.expense-panel-primary {
    border-color: $brand-primary; //#b92d33;
    width: 1580px;
}
/*.panel-heading{
  padding: 8px 25px 5px 40px;
}*/


.panel-default&gt;.panel-heading {
  color: #333;
  background-color: $brand-primary; //#b92d33;
  border-color: #e4e5e7;
  padding: 0;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.panel-default&gt;.panel-heading a {
  display: block;
  padding: 10px 15px;
}

.panel-default&gt;.panel-heading a[aria-expanded="true"] {
  background-color: $brand-primary; //#b92d33;
}

.doublon-1  {
	color:#efaa0f;
  font-weight: 600;
}

.doublon-0 {
  color: inherit;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>expense_sheet_manager</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Expense Sheet - Listing My Team</name>
        <option_schema>[{"name":"","section":"other","label":"","type":"string"}]</option_schema>
        <public>false</public>
        <roles>snc_internal,sn_esm_user</roles>
        <script><![CDATA[(function() {
	
	var isApproverUser = false;
	var isApproverDelegate = false;
	var user = new GlideRecord('sys_user');
	if(user.get(gs.getUserID())){
		isApproverUser = user.u_expense_approver;
	}
	
	var userDelegate = new GlideRecord('sys_user_delegate');
	userDelegate.addEncodedQuery("user="+gs.getUserID()+"^u_expense_approval=true");
	userDelegate.setLimit(1);
	userDelegate.query();
	while (userDelegate.next()) {
		isApproverDelegate = userDelegate.u_expense_approval;
	}

	data.isApprover = isApproverUser || isApproverDelegate;
	
	var gDate = new GlideDate();
	data.nowDate = new GlideDateTime(gDate) + "";
  data.setDisplayAppTeam = '=1';
  data.fields = 'expsheet_sys_id,expline_status,expline_sys_id,expsheet_number,expline_date_expense,expsheet_short_description,expsheet_opened_by,expsheet_requested_for,expsheet_contract,expline_rubric,expsheet_category,expsheet_status,expsheet_total_requested_amount,expsheet_total_refunded_amount,expline_duplicated';

	data.reqExpSheetId='';
	data.action='';
	data.comment='undefined';
	
	// ******************************************************************
	
	var expParent='';

	if(input && input.reqExpSheetId!='') {
		if(input.action == 'approve') {
			var scApprove = new GlideRecord('sysapproval_approver');
			scApprove.addQuery("document_id",input.reqExpSheetId);
			scApprove.query();
			while(scApprove.next()) {
				scApprove.state ='approved';
				scApprove.update();
			}
		}	
		 data.reqExplineId='';
		 data.action='';
		 data.comment='';
		}
 
		if(input && input.reqExpSheetId!='') {
			if(input.action == 'reject' && input.comment != 'undefined') {
				var scReject = new GlideRecord('sysapproval_approver');
				scReject.addQuery("document_id",input.reqExpSheetId);
				scReject.query();
				if(scReject.next()) {
					scReject.state ='rejected';
					scReject.comments=input.comment;
					scReject.update();
				}
			}	

			data.reqExplineId='';
			data.action='';
			data.comment='';
			}

	  data.fieldslabels = getFieldLabels('');
			
		function getFieldLabels(keywords) {
		var scApp = new GlideRecord('x_hdvi2_expense_view');
				//Split the field defined by the options
				var tableFields = data.fields.split(',');
				data.tableFields = tableFields;

				var results = [];

				//initialialize table that will be used in the HTML
				data.approved = [];  
			
				//scApp.addEncodedQuery('expsheet_status'+data.setDisplayAppTeam+'^expline_active=true^expsheet_active=true^expsheet_approverDYNAMIC90d1921e5f510100a9ad2572f2b477fe');
				scApp.addEncodedQuery('expsheet_status'+data.setDisplayAppTeam+'^expline_active=true^expsheet_active=true');
				scApp.orderByDesc("expline_date_expense");
				scApp.query();
			
        for(var i = 0; i < tableFields.length ; i++) {
						if(i==1) results.push(scApp.getElement(tableFields[i]).getED().getLabel()+'_line');
						else results.push(scApp.getElement(tableFields[i]).getED().getLabel());    
				}
			
				while(scApp.next()) {
						var objApp = {};
						for(var n = 0 ; n < data.tableFields.length ; n++) {
							if(n==12 || n==13) objApp[data.tableFields[n]] = parseFloat(scApp.getValue(data.tableFields[n])).toFixed(2);
							else if(n==14 || n==11) objApp[data.tableFields[n]] = scApp.getValue(data.tableFields[n]);
							else objApp[data.tableFields[n]] = scApp.getDisplayValue(data.tableFields[n]);
						}					
						
					if(isLoggedUserApprover(scApp.expsheet_approver) || scApp.expsheet_approver.indexOf(gs.getUserID())!=-1)
						data.approved.push(objApp);
				}	
			return results;
	}
	
	// ******************************************************************
	function isLoggedUserApprover(appSysID) {
		var retVal  = false;
		var userDelegate = new GlideRecord('sys_user_delegate');
		userDelegate.addEncodedQuery("userIN"+appSysID+"^u_expense_approval=true^delegate="+gs.getUserID());
		userDelegate.setLimit(1);
		userDelegate.query();
		while (userDelegate.next()) {
			retVal = userDelegate.u_expense_approval;
		}
		return retVal;
	}

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>h40009222</sys_created_by>
        <sys_created_on>2020-02-24 13:11:27</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>d8dc9cebdb4f4050011e177e169619dc</sys_id>
        <sys_mod_count>258</sys_mod_count>
        <sys_name>Expense Sheet - Listing My Team</sys_name>
        <sys_package display_value="Expense Management" source="x_hdvi2_expense">50e8c3d7dbea0090f5e2174b06961954</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Expense Management">50e8c3d7dbea0090f5e2174b06961954</sys_scope>
        <sys_update_name>sp_widget_d8dc9cebdb4f4050011e177e169619dc</sys_update_name>
        <sys_updated_by>h40009222</sys_updated_by>
        <sys_updated_on>2020-05-05 16:48:55</sys_updated_on>
        <template><![CDATA[<div class="pointer ng-binding ng-scope" style="display:none;">
  <textarea ng-model="comment" maxlength="1024"></textarea>
  <input type="text" ng-model="reqExpSheetId">
  <input type="text" ng-model="action" value="">
  <input type="text" ng-model="setDisplayAppTeam">
</div>
<p/>
<div ng-if="data.isApprover" class="container">
 <div class="clearfix"></div>
 <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
   <div class="panel panel-default">
      <div class="panel-heading" role="tab" id="headingOne">
          <a class="collapsed" data-toggle="collapse" data-parent="#accordion" aria-expanded="true" aria-controls="collapseOne">
            <h4 class="panel-title">
              <span class="panel-title ng-binding">${expense.label.expense.approval.pending}</span>
              <span class="m-r-sm fa ng-scope fa-refresh" style="font-size:20px; color:white; float:right;" aria-hidden="true" name="reload" role="button" ng-click="c.server.update()"></span>
        		</h4>
          </a>
      </div>
      <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
        <div class="panel expense-panel-primary">
          <div class="panel-body">
          <p>
          </p>
          <div  ng-if="data.approved.length > 0" >
            <table class="table table-striped table-responsive ng-scope" style=""> 
              <thead>
                <tr class="tr-top">
                  <th ng-if="labels!='Sys ID' && labels!='Status' && labels!='Status_line' && labels!='Statut_line' && labels!='Statut' && labels!='Total Refunded Amount' && labels!='Montant validé' && labels!='Duplicated' && labels!='Doublon' && labels!='validierter Betrag'" class="thead text-nowrap ng-binding" ng-repeat="labels in c.data.fieldslabels track by $index" ng-click="setOrderBy(labels)" tabindex="0" role="button">
                    <div class="th-exp-title ng-binding" aria-label="Sort by  {{labels}}">
                      {{labels}}
                    </div>
                  </th>
                </tr>
              </thead>
              <tr ng-repeat="record in data.approved track by $index" class="doublon-{{record['expline_duplicated']}}">
                <td ng-if="field!='expsheet_sys_id' && field!='expline_sys_id' && field!='expline_status' && field!='expsheet_status' && field!='expsheet_total_refunded_amount' && field!='expline_duplicated'" ng-repeat="field in data.tableFields track by $index" tabindex="0">
                  <div ng-if="field=='expsheet_number' && field!='expsheet_sys_id' && field!='expsheet_total_requested_amount'" class="pointer sp-list-cell ng-binding ng-scope">
                    <i ng-if="record['expline_duplicated']==1" class="fa fa-warning" style="font-size:16px;color:#ff5200;" title="${expense.duplicates.warning}">&nbsp;</i>{{record[field]}}
                  </div>
                  <div ng-if="field!='expsheet_number' && field!='expsheet_sys_id' && field!='expsheet_total_requested_amount'" class="sp-list-cell ng-binding ng-scope">
                    {{record[field]}}
                  </div>
                 <div ng-if="field=='expsheet_total_requested_amount'" class="sp-list-cell ng-binding ng-scope" style="float:right;">
                    {{record[field]}}
                  </div>
                </td>
                <td class="td-alignmiddle">
                  <div class="pointer ng-binding ng-scope">
                    <i class="fa fa-eye" name="viewonly" id="viewonly" style="font-size:26px;color:#0089ff;" ng-click="c.onWidgetOnly(record['expline_sys_id'])" title="${expense.view_only.request}" role="button"></i>
                  </div>
                </td>
                <td class="td-alignmiddle" >
                  <div ng-if="record['expsheet_status']==1" class="pointer ng-binding ng-scope">
                    <img class ="td_img" name="approve" src="hvs_approve_expense.svg" alt="${expense.approve.request}" title="${expense.approve.request}" align="middle" role="button" ng-click="c.SetApprovalExpense(record['expsheet_sys_id'],'approve')">
                  </div>
                </td>
                <td class="td-alignmiddle">
                  <div ng-if="record['expsheet_status']==1" class="pointer ng-binding ng-scope">
                    <img class ="td_img" name="reject" src="hvs_reject_expense.svg" alt="${expense.reject.request}"  title="${expense.reject.request}" align="middle" role="button" ng-click="c.SetApprovalExpense(record['expsheet_sys_id'],'reject')">
                  </div>
                </td>
                </tr>
            </table>
          </div>  
          <div  ng-if="data.approved.length == 0" >
              <table class="table table-striped table-responsive ng-scope" ng-if="c.data.records.length == 0" style="">
                <thead>
                  ${expense.label.expense.no_expense.approve}
                </thead>
              </table>  
          </div>  
        </div>
      </div>
    </div>
    </div>
    <!-- ***************************************************** -->  
</div>
</div>  ]]></template>
    </sp_widget>
</record_update>
